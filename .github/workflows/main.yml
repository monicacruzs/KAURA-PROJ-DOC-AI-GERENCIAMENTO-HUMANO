name: CI/CD do Document Intelligence

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      model_to_run:
        description: 'Selecione o ID do modelo a ser executado'
        required: true
        default: 'kaura-custom-viagem-v4'
        type: choice
        options:
          - kaura-custom-viagem-v4
          - prebuilt-invoice
          - prebuilt-layout
          
# OIDC: Permiss√£o NECESS√ÅRIA para o Action solicitar o token JWT do GitHub
permissions:
  id-token: write 
  contents: read

jobs:
  analyze_document:
    runs-on: ubuntu-latest
    environment: dev
    
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11' 
          cache: 'pip'
          
      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: üîë Azure Login (via AZURE_CREDENTIALS Secret)
        # Recomendo usar o AZURE_CREDENTIALS que voc√™ gerou, trocando este passo de OIDC
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # --- DEFINI√á√ÉO DO ENDPOINT E KEY VAULT URI (Vari√°veis de ambiente) ---
      - name: Set Environment Variables
        run: |
          # ENDPOINT (Via Secret)
          echo "AZURE_FORM_RECOGNIZER_ENDPOINT=${{ secrets.AZURE_FORM_RECOGNIZER_ENDPOINT }}" >> $GITHUB_ENV
          # URI do Key Vault (Via Secret) - Agora inclu√≠do
          echo "AZURE_KEY_VAULT_URI=${{ secrets.AZURE_KEY_VAULT_URI }}" >> $GITHUB_ENV

      # --- CR√çTICO: PREPARA√á√ÉO DE DADOS CONDICIONAL ---
      - name: üìÇ Prepare Input Data
        run: |
          # Cria a pasta de dados que o analyze_doc_ai.py espera
          mkdir -p dados
          
          # Determina o arquivo de entrada com base no modelo selecionado
          case '${{ github.event.inputs.model_to_run }}' in
            "kaura-custom-viagem-v4")
              # Certifique-se que o seu PDF de teste de viagem est√° na raiz
              cp documento_viagem_teste.pdf dados/documento_viagem_teste.pdf
              ;;
            "prebuilt-invoice")
              # Certifique-se que o seu PDF de teste de fatura est√° na raiz
              cp fatura-teste.pdf dados/fatura-teste.pdf
              ;;
            "prebuilt-layout")
              # Certifique-se que o seu JPEG/PDF de teste de layout est√° na raiz
              cp documento-teste.jpeg dados/documento-teste.jpeg
              ;;
          esac

      - name: üèÉ Execute Document Analysis
        run: |
          # Tenta obter o input, e se for nulo (vazio), usa 'kaura-custom-viagem-v4' como padr√£o.
          MODEL_ID="${{ github.event.inputs.model_to_run }}"
          
          # Uso do Bash para checar se a vari√°vel est√° vazia (ocorre em push/PR)
          if [ -z "$MODEL_ID" ]; then
            MODEL_ID="kaura-custom-viagem-v4"
            echo "Aten√ß√£o: O input do modelo estava vazio. Usando o modelo padr√£o: $MODEL_ID"
          fi
          
          # Executa o script com o valor (garantido) do MODEL_ID
          python src/analyze_doc_ai.py --model-id "$MODEL_ID"

      - name: Upload Artifacts (Output JSON/TXT)
        uses: actions/upload-artifact@v4
        with:
          name: analysis-output-${{ github.event.inputs.model_to_run }}
          # Path √© o local onde o seu analyze_doc_ai.py salva o output (dados/ ou outputs/)
          path: outputs/
