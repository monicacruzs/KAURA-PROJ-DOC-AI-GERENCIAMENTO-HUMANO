name: Deploy Function App to Azure

on:
  push:
    branches:
      - main # Dispara o deploy quando há push ou merge para a branch 'main'
    paths:
      - 'kaura-func-app-01/**' # Apenas se houver alterações na pasta da função

env:
  AZURE_FUNCTIONAPP_NAME: kaura-func-app-01 # Seu Function App
  AZURE_RG_NAME: RG-KAURA-DOC-AI # Seu Resource Group
  PYTHON_VERSION: '3.10'
  
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    # 1. Login no Azure usando o Service Principal armazenado no AZURE_CREDENTIALS
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # 2. Configura o ambiente Python
    - name: Setup Python environment
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    # 3. Instala as dependências (requer o requirements.txt na pasta kaura-func-app-01/)
    - name: Install dependencies
      run: |
        python -m venv .venv
        source .venv/bin/activate
        pip install -r kaura-func-app-01/requirements.txt
        deactivate

    # 4. Deployment da Function App (Envia a pasta kaura-func-app-01)
    - name: 'Deploy to Azure Function App'
      uses: Azure/functions-action@v1
      with:
        app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
        resource-group: ${{ env.AZURE_RG_NAME }}
        package: 'kaura-func-app-01'
        scm-do-build-during-deployment: true
